trigger:
  branches:
    include:
      - main

pool:
  name: myjuly-agent-pool

variables:
  RESOURCE_GROUP: 'myjulyproject-rg'
  APP_SERVICE_PLAN: 'myjulyproject-plan'
  APP_NAME: 'myjulyproject-app'
  MYSQL_SERVER_NAME: 'myjuly-mysqlserver'
  MYSQL_ADMIN: 'dbadmin'
  MYSQL_DB: 'myjulydb'
  MYSQL_PASSWORD: 'P@ssw0rd'
  LOCATION: 'canadacentral'
  
  

stages:
- stage: Build
  displayName: Build Stage
  jobs:
    - job: BuildJob
      displayName: Build Spring Boot App
      steps:
        - checkout: self
        - task: Maven@4
          inputs:
            mavenPomFile: 'springbootdemo/pom.xml'
            goals: 'clean package'
            javaHomeOption: 'JDKVersion'
            jdkVersionOption: '1.17'
            publishJUnitResults: true
            testResultsFiles: '**/surefire-reports/TEST-*.xml'

- stage: Deploy
  displayName: Deploy to Azure
  dependsOn: Build
  jobs:
    - job: DeployJob
      displayName: Provision & Deploy
      steps:
        - task: AzureCLI@2
          displayName: 'Provision Azure Resources'
          inputs:
            azureSubscription: 'myfirstconn'
            scriptType: 'ps'
            scriptLocation: 'inlineScript'
            inlineScript: |              
              
              az webapp create --resource-group $(RESOURCE_GROUP) --plan $(APP_SERVICE_PLAN) --name $(APP_NAME) --runtime "JAVA:17-java17"
              Write-Output "WebApp Creation Stage Completed"
              az mysql flexible-server create --resource-group $(RESOURCE_GROUP) --name $(MYSQL_SERVER_NAME) --admin-user $(MYSQL_ADMIN) --admin-password $(MYSQL_PASSWORD) --sku-name Standard_B1ms --location $(LOCATION) --storage-size 32 --version 8.4 --public-access 0.0.0.0
              $resourceGroup = "myjulyproject-rg"
              $mysqlServerName = "myjuly-mysqlserver"
            
              $retryCount = 0
              $maxRetries = 10
            
              while ($retryCount -lt $maxRetries) {
                   $status = az mysql flexible-server show `
                       --resource-group $resourceGroup `
                       --name $mysqlServerName `
                       --query "state" -o tsv
               
                   if ($status -eq "Ready") {
                       Write-Output "‚úÖ MySQL server is ready."
                       break
                   }
               
                   Write-Output "‚è≥ Waiting for MySQL server to be ready... (current state: $status)"
                   Start-Sleep -Seconds 15
                   $retryCount++
               }
               
               if ($status -ne "Ready") {
                   Write-Output "‚ùå MySQL server did not become ready within expected time."
                   exit 1
               }
                          
              az mysql flexible-server db create --resource-group $(RESOURCE_GROUP) --server-name $(MYSQL_SERVER_NAME) --database-name $(MYSQL_DB)
              Write-Output "DB schema Creation Stage Completed"
              az webapp config appsettings set `
                --resource-group $(RESOURCE_GROUP) `
                --name $(APP_NAME) `
                --settings `
                  MYSQL_HOST=$(MYSQL_SERVER_NAME).mysql.database.azure.com `
                  MYSQL_DB=$(MYSQL_DB) `
                  MYSQL_USER=$(MYSQL_ADMIN)@$(MYSQL_SERVER_NAME) `
                  MYSQL_PASSWORD=$(MYSQL_PASSWORD)
              Write-Output "‚úÖ WebApp mapped to related DB credentials Stage Completed"
              $webappUrl = az webapp show --name $(APP_NAME) --resource-group $(RESOURCE_GROUP) --query defaultHostName -o tsv
              Write-Output "üåê WebApp URL: https://$webappUrl"
        - task: AzureWebApp@1
          displayName: 'Deploy Spring Boot App'
          inputs:
            azureSubscription: 'myfirstconn'
            appType: 'webAppLinux'
            appName: '$(APP_NAME)'
            package: '$(System.DefaultWorkingDirectory)/target/*.jar'
            
